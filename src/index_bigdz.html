<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FriendsFilter</title>
    <style type="text/css">
        .main-container{
            /*display: flex;*/
        }

        .friends {
            width: 400px;
            outline: 1px solid red;
            height: 500px;
            overflow-y: scroll;
        }

        ul {
            width: 400px;
            height: 500px; /* если задать div-у сверху то выйдет за границы */
            overflow-y: scroll;
            list-style: none;
            margin: 0;
            padding: 0;
            outline: 1px solid red;
        }
        ul li {
            border: 1px solid lightgrey;
            width: inherit;
        }

        table {
            border-collapse: collapse;
        }

    </style>
    <script src="https://vk.com/js/api/openapi.js?146" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.10/handlebars.min.js"></script>
</head>
<body>
    <div class="main-container">
        <table>
            <tr><td><input type="text" class="lft_inpt" name="name_search"></td>
                <td><input type="text" class="lkovr_rght_lst" name="name_search"></td>
            </tr>
            <tr><td class="friends"><ul class="lft_list friends-pick"></ul></td>
                <td class="friends"><ul class="rght_list friends-pick droppable"></ul></td>
            </tr>
        </table>
        <!--<input type="text" name="name_search">-->
        <!--<div class="friends"><ul class="friends-pick"></ul></div>-->
        <!--<div class="friends droppable"><ul class="friends-pick"></ul></div>-->
    </div>
    <script>
        var left_input = document.querySelector('.lft_inpt');
        var chunk = left_input.value;

            left_input.addEventListener('keyup', (e) => {
            return new Promise ((resolve, reject) => {
                var get_lst = document.querySelector('.lft_list').children;
                get_lst = Array.from(get_lst);
                var all_names = [];

                get_lst.forEach(i => {
                    var name_elem = i.querySelector('.name');
                    all_names.push(name_elem.innerText);
                })
                resolve(all_names);
            })
                .then ((all_names => {

                }))
        })
    </script>
    <script>

        var template = `
        {{#each items}}
            <li class="draggable">
                <img src ="{{photo_100}}">
                <div class="name">{{first_name}} {{last_name}}</div>
            </li>
        {{/each}}`

        var friends_left = document.querySelector('.friends-pick');
        var templateFn = Handlebars.compile(template);

        function vkApi(method, options) {
            if (!options.v) {
                options.v = '5.64';
            }

            return new Promise((resolve, reject) => {
                VK.api(method, options, response => {
                    if (response.error) {
                        reject(new Error(response.error.error_msg));
                    } else {
                        resolve(response);
                    }
                })
            })
        }

        function vkInit() {
            return new Promise((resolve, reject)=> {
                VK.init({
                    apiId: 6066978
                });

                VK.Auth.login((response) => {
                    if (response.session) {
                        resolve(response.session);
                    } else {
                        reject(new Error('Couldn\'t log in'));
                    }
                }, 2)
            })
        }

        new Promise(resolve => window.onload = resolve)
        .then(() => vkInit())
        .then(() => vkApi('friends.get', {fields: 'photo_100'}))
        .then(result => friends_left.innerHTML = templateFn(result.response));

        friends_left.addEventListener('mousedown', (e) => {
            var elem = e.target.closest('.draggable');
            if(!elem) return;

            var coords = getCoords(elem);
            var shiftX = e.pageX - coords.left;
            var shiftY = e.pageY - coords.top;

            elem.style.position = 'absolute';
            moveAt(e);

            elem.style.zIndex = 1000;

            function moveAt(e) {
                elem.style.left = e.pageX - shiftX +'px';
                elem.style.top = e.pageY - shiftY +'px';
            }

            document.addEventListener('mousemove', (e) => {
                moveAt(e);
            });
            document.addEventListener('mouseup', () => {

                function findDrop(element) {
                    element.hidden = true;
                    var curr_cursor = document.elementFromPoint(event.clientX, event.clientY);
                    console.log(curr_cursor);
                    element.hidden = false;

                    if (element == null) {
                        return null;
                    }

                    return curr_cursor.closest('.droppable');
                }

                var drop_elem = findDrop(elem);

                    if(drop_elem) {
//                        var list = drop_elem.getElementsByTagName('ul');
                        drop_elem.appendChild(elem);
                        elem.style.position = 'relative';
                        elem.style.top = 0;
                        elem.style.left = 0;
                        elem.style.zIndex = -1;
                        elem = null;
                    }
                });

            //ВОПРОC>>??: если ниже код реализовать с addEventListener - фото будет отдельно тянуться
            elem.ondragstart = function() {
                return false;
            }
        });

        function getCoords(elem) { // кроме IE8-
            var box = elem.getBoundingClientRect();

            return {
                top: box.top + pageYOffset,
                left: box.left + pageXOffset
            };
        }
    </script>
</body>
</html>