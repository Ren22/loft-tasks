<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FriendsFilter</title>
    <style type="text/css">
        .main-container{
            /*display: flex;*/
        }

        .friends {
            width: 400px;
            outline: 1px solid red;
            height: 500px;
            overflow-y: scroll;
        }

        ul {
            width: 400px;
            height: 500px; /* если задать div-у сверху то выйдет за границы */
            overflow-y: scroll;
            list-style: none;
            margin: 0;
            padding: 0;
            outline: 1px solid red;
        }
        ul li {
            border: 1px solid lightgrey;
            width: inherit;
        }

        table {
            border-collapse: collapse;
        }

    </style>
    <script src="https://vk.com/js/api/openapi.js?146" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.10/handlebars.min.js"></script>
</head>
<body>
    <div class="main-container">
        <table>
            <tr><td><input type="text" class="lft_inpt" name="name_search"></td>
                <td><input type="text" class="rght_inpt" name="name_search"></td>
            </tr>
            <tr><td class="friends"><ul class="friends-left"></ul></td>
                <td class="friends"><ul class="friends-right droppable"></ul></td>
            </tr>
        </table>
        <!--<input type="text" name="name_search">-->
        <!--<div class="friends"><ul class="friends-pick"></ul></div>-->
        <!--<div class="friends droppable"><ul class="friends-pick"></ul></div>-->
    </div>

    <script>
        /******************
         * VK.com connection
         ******************/

        var template = `
        {{#each items}}
            <li class="draggable">
                <img src ="{{photo_100}}">
                <div class="name">{{first_name}} {{last_name}}</div>
            </li>
        {{/each}}`

        var friends_left = document.querySelector('.friends-left');
        var friends_right = document.querySelector('.friends-pick');
        var templateFn = Handlebars.compile(template);

        function vkApi(method, options) {
            if (!options.v) {
                options.v = '5.64';
            }

            return new Promise((resolve, reject) => {
                VK.api(method, options, response => {
                    if (response.error) {
                        reject(new Error(response.error.error_msg));
                    } else {
                        resolve(response);
                    }
                })
            })
        }

        function vkInit() {
            return new Promise((resolve, reject)=> {
                VK.init({
                    apiId: 6066978
                });

                VK.Auth.login((response) => {
                    if (response.session) {
                        resolve(response.session);
                    } else {
                        reject(new Error('Couldn\'t log in'));
                    }
                }, 2)
            })
        }

        new Promise(resolve => window.onload = resolve)
        .then(() => vkInit())
        .then(() => vkApi('friends.get', {fields: 'photo_100'}))
        .then(result => friends_left.innerHTML = templateFn(result.response));

        /******************
         * Drag'n'drop
         ******************/

        friends_left.addEventListener('mousedown', (e) => {
            var elem = e.target.closest('.draggable');
            if(!elem) return;

            var coords = getCoords(elem);
            var shiftX = e.pageX - coords.left;
            var shiftY = e.pageY - coords.top;

            elem.style.position = 'absolute';
            moveAt(e);

            elem.style.zIndex = 1000;

            function moveAt(e) {
                if (elem) {
                    elem.style.left = e.pageX - shiftX + 'px';
                    elem.style.top = e.pageY - shiftY + 'px';
                }
            }

            document.addEventListener('mousemove', (e) => {
                moveAt(e);
            });

            document.addEventListener('mouseup', (e) => {

                var drop_elem = findDrop(elem);

                function findDrop(element) {
                    if (element) {
                        element.hidden = true;
                        var curr_cursor = document.elementFromPoint(event.clientX, event.clientY);
                        console.log(curr_cursor);
                        element.hidden = false;

                        return curr_cursor.closest('.droppable');
                    }
                }

                    if(drop_elem) {
                        drop_elem.appendChild(elem);
                        elem.style.position = 'relative';
                        elem.style.top = 0;
                        elem.style.left = 0;
                        elem.style.zIndex = -1;
                        elem = null;
                    }
                });

            //ВОПРОC>>??: если ниже код реализовать с addEventListener - фото будет отдельно тянуться
            elem.ondragstart = function() {
                return false;
            }
        });

        function getCoords(elem) { // кроме IE8-
            var box = elem.getBoundingClientRect();

            return {
                top: box.top + pageYOffset,
                left: box.left + pageXOffset
            };
        }

        function isMatching(full, chunk) {
            full = full.toLowerCase();
            chunk = chunk.toLowerCase();
            if (~full.indexOf(chunk)) {

                return true;
            } else {

                return false;
            }
        }

        /******************
         * Search for user in a list
         ******************/


        var left_input = document.querySelector('.lft_inpt');
        var right_input = document.querySelector('.rght_inpt');

        left_input.addEventListener('keyup', (e) => {
            var chunk = left_input.value;
            var picked_names = [];
            var get_lst = document.querySelector('.friends-left').children;

            chunk = chunk.replace(/\s/g, '');
            get_lst = Array.from(get_lst);
            if (chunk != '') {
                get_lst.forEach(i => { //every i is li element
                    var elem_name = i.querySelector('.name').innerText;

                    i.hidden = true; //make all elements from the initial list hidden
                    elem_name = elem_name.replace(/\s/g, '');
                    if (isMatching(elem_name, chunk)) {
                        i.hidden = false; //show only those that appear in search input
                        picked_names.push(i);
                    }
                })
            } else {
                get_lst.forEach(i => {
                    i.hidden = false;
                })
            }
        })

        right_input.addEventListener('keyup', (e) => {
            var chunk = right_input.value;
            var picked_names = [];
            var get_lst = document.querySelector('.friends-right').children;

            chunk = chunk.replace(/\s/g, '');
            get_lst = Array.from(get_lst);
            if (chunk != '') {
                get_lst.forEach(i => { //every i is li element
                    var elem_name = i.querySelector('.name').innerText;

                    i.hidden = true; //make all elements from the initial list hidden
                    elem_name = elem_name.replace(/\s/g, '');
                    if (isMatching(elem_name, chunk)) {
                        i.hidden = false; //show only those that appear in search input
                        picked_names.push(i);
                    }
                })
            } else {
                get_lst.forEach(i => {
                    i.hidden = false;
                })
            }
        })

    </script>
</body>
</html>